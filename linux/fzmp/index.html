<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    
    <title>Fuzzy searching for MPD in Bash | DanielFGray</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
        <meta name="keywords" content="bash,fzf,mpd" />
    
    <meta name="description" content="if this is tl;dr you can just read the script hereI recently came across fzf, which is a fuzzy search filter. By default fzf will fuzzy search recursively through files in the current directory, but i">
<meta property="og:type" content="article">
<meta property="og:title" content="Fuzzy searching for MPD in Bash">
<meta property="og:url" content="http://danielfgray.github.io/linux/fzmp/index.html">
<meta property="og:site_name" content="DanielFGray">
<meta property="og:description" content="if this is tl;dr you can just read the script hereI recently came across fzf, which is a fuzzy search filter. By default fzf will fuzzy search recursively through files in the current directory, but i">
<meta property="og:updated_time" content="2016-05-16T02:39:45.567Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Fuzzy searching for MPD in Bash">
<meta name="twitter:description" content="if this is tl;dr you can just read the script hereI recently came across fzf, which is a fuzzy search filter. By default fzf will fuzzy search recursively through files in the current directory, but i">
    

    

    

    <link rel="stylesheet" href="/vendor/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/vendor/titillium-web/styles.css">
    <link rel="stylesheet" href="/vendor/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/vendor/jquery/2.0.3/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/vendor/fancybox/jquery.fancybox.css">
    
    
        <link rel="stylesheet" href="/vendor/scrollLoading/style.css">
    
    
    

</head>

<body>
    <div id="wrap">
        <header id="header">
    <div id="header-outer" class="outer">
        <div class="container">
            <div class="container-inner">
                <div id="header-title">
                    <h1 class="logo-wrap">
                        <a href="/" class="logo"></a>
                    </h1>
                    
                </div>
                <div id="header-inner" class="nav-container">
                    <a id="main-nav-toggle" class="nav-icon fa fa-bars"></a>
                    <div class="nav-container-inner">
                        <ul id="main-nav">
                            
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/">Home</a>
                                </li>
                            
                                        <ul class="main-nav-list"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/drums/">drums</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/linux/">linux</a></li></ul>
                                    
                        </ul>
                        <nav id="sub-nav">
                            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>
        <div class="container">
            <div class="main-body container-inner">
                <div class="main-body-inner">
                    <section id="main">
                        <div class="main-body-header">
    <h1 class="header">
    
    <a class="page-title-link" href="/linux/">linux</a>
    </h1>
</div>
                        <div class="main-body-content">
                            <article id="post-fzmp" class="article article-single article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
        Fuzzy searching for MPD in Bash
        </h1>
    

            </header>
        
        <div class="article-subtitle">
            <a href="/linux/fzmp/" class="article-date">
    <time datetime="2014-11-02T05:00:00.000Z" itemprop="datePublished">2014-11-02</time>
</a>
            
    <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/bash/">bash</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/fzf/">fzf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mpd/">mpd</a></li></ul>

        </div>
        <div class="article-entry" itemprop="articleBody">
            <p>if this is tl;dr you can just read the script <a href="https://github.com/DanielFgray/dotfiles/blob/master/local/bin/fzmp" target="_blank" rel="external">here</a></p><p>I recently came across <a href="https://github.com/junegunn/fzf" target="_blank" rel="external">fzf</a>, which is a fuzzy search filter. By default <code>fzf</code> will fuzzy search recursively through files in the current directory, but it also filters through stdin.</p><p>Realizing it was a generic filter, and not just for files, I wondered what else I could fuzzy search through, and being a musician, I felt that filtering through my music library would be handy.</p><p><code>mpc</code> is a CLI interface to mpd, and after reading through the <a href="http://man.cx/mpc(1" target="_blank" rel="external">man page</a>), I find that <code>mpc listall</code> will display a list of every song in the mpd database. So immediately I ran <code>mpc listall | fzf</code>, which worked as I expected. Only, <code>fzf</code> just prints the selection to stdout, it doesn’t actually <em>do</em> anything. So after reading the man page some more and tinkering around, I learn that <code>mpc add</code> will take files from stdin and add them to the bottom of the playlist.</p><p>So <code>mpc listall | fzf | mpc add</code> will list all available files in the mpd database, fuzzy filter through them, then add to the bottom of the playlist. Unfortunately, that still doesn’t actually play the added song, and <code>mpc play</code> will only play whatever song is currently selected in the queue, rather than our new song. In the end I found that <code>mpc play</code> accepts an integer as an index from the playlist. So, if <code>mpc add</code> puts them at the bottom, we need to know how many songs are in the playlist, which we can achieve with <code>mpc playlist | wc -l</code> (<code>wc</code> is wordcount, the <code>-l</code> switch counts lines). At this point my code is better suited to a script rather than a one-liner like:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mpc listall | fzf | mpc add &amp;&amp; mpc play $(mpc playlist | wc <span class="_">-l</span>)</span><br></pre></td></tr></table></figure><p>Which has some weird quirks if you don’t actually add a song. And what if we want to add multiple songs? <code>fzf</code> has the <code>-m</code> switch to select multiple lines, and <code>mpc add</code> happily adds as many songs as you give it.</p><p>After talking to #bash on freenode they pointed out we’d be better off using an array for multiple files, and <code>mapfile</code> is perfect for this. The biggest benefit to using an array here is that we have built-in functionality for counting the elements, rather than repeatedly calling <code>wc -l</code>.</p><p><code>mapfile -t songs &lt; &lt;(mpc listall | fzf -m)</code> will create a variable called <code>$songs</code> as an array with all the lines as individual elements. We’re also using process substitution here because <a href="http://wiki.bash-hackers.org/commands/builtin/mapfile" target="_blank" rel="external">mapfile</a> expects stdin, but our input is a command, so we use the <code>&lt;()</code> penguin-looking syntax to trick mapfile into thinking our command is really a file . Bash’s quirky <a href="http://wiki.bash-hackers.org/syntax/arrays" target="_blank" rel="external">array syntax</a> gives us <code>${songs[@]}</code> as a reference to all items in the array, and <code>$(#songs[@])</code> to count the amount of items in our <code>$songs</code> array. And with all of this information we have all the pieces to make our fuzzy music finder.</p><p>Using the array, we want to pass each element as a string separated by a newline. This can be done with a little <code>printf</code> magic: <code>printf &#39;%s\n&#39; &quot;${songs[@]}&quot;</code> and that is easily piped into <code>mpc add</code>.</p><p>If we assign a variable to the length of the playlist (which we got with <code>mpc playlist | wc -l</code>) we can tell <code>mpc play</code> to play the last song in the playlist. But if we select multiple songs, we want it to start playing the first of them, so we need a little bit of simple math to figure out how many songs back to start from the bottom. So if our array is longer than one item, we want to reassign our index variable to the length of the playlist minus however many items we added from our <code>$songs</code> array, and add one (because without adding one we would just have the last item in the playlist before we added anything).</p><p>So, putting it all together I came up with this:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mapfile</span> -t songs &lt; &lt;(mpc listall | sort | fzf -m <span class="_">-e</span> +s)</span><br><span class="line"><span class="keyword">if</span> (( <span class="variable">$&#123;#songs[@]&#125;</span> &gt; 0 )); <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">printf</span> <span class="string">'%s\n'</span> <span class="string">"<span class="variable">$&#123;songs[@]&#125;</span>"</span> | mpc -q add</span><br><span class="line">  index=$(mpc playlist | wc <span class="_">-l</span>)</span><br><span class="line">  <span class="keyword">if</span> (( <span class="variable">$&#123;#songs[@]&#125;</span> &gt; 1 )); <span class="keyword">then</span></span><br><span class="line">    index=$(( <span class="variable">$index</span> - <span class="variable">$&#123;#songs[@]&#125;</span> + 1))</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  mpc -q play <span class="string">"<span class="variable">$index</span>"</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><p>I added the <code>sort</code> filter so the list is alphabetical and the <code>+s</code> switch in fzf preserves the sorting, and the <code>-e</code> allows for regex in the match.</p><p>The <a href="https://github.com/DanielFgray/dotfiles/blob/master/local/bin/fzmp" target="_blank" rel="external">full script</a> has some more things to make it more friendly and useable, but this is the core functionality of our script.</p><p>I hope this was as educational to you as it was fun for me to make!</p>
        </div>
        <footer class="article-footer">
            



    <a data-url="http://danielfgray.github.io/linux/fzmp/" data-id="cioadttny0001kzo10qwd22lc" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

        </footer>
    </div>
</article>

    <section id="comments">
    
        
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>

    
    </section>

                        </div>
                    </section>
                    <aside id="sidebar">
    <a class="sidebar-toggle" title="Expand Sidebar"><i class="toggle icon"></i></a>
    <div class="sidebar-top">
        <p>follow:</p>
        <ul class="social-links">
            
                
                <li>
                    <a class="social-tooltip" title="github" href="https://github.com/DanielFGray" target="_blank">
                        <i class="icon fa fa-github"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="facebook" href="http://fb.me/DanielFGray" target="_blank">
                        <i class="icon fa fa-facebook"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="instagram" href="http://instagram.com/UKDrummerInTx" target="_blank">
                        <i class="icon fa fa-instagram"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="lastfm" href="https://last.fm/user/thebritishkid" target="_blank">
                        <i class="icon fa fa-lastfm"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="reddit" href="https://reddit.com/u/DanielFGray" target="_blank">
                        <i class="icon fa fa-reddit"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="soundcloud" href="https://soundcloud.com/DanielFGray" target="_blank">
                        <i class="icon fa fa-soundcloud"></i>
                    </a>
                </li>
                
            
        </ul>
    </div>
    
        
<nav id="article-nav">
    
        <a href="/linux/vimrc-guide/" id="article-nav-newer" class="article-nav-link-wrap">
        <strong class="article-nav-caption">newer</strong>
        <p class="article-nav-title">
        
            Vim beginner&#39;s customization guide
        
        </p>
        <i class="icon fa fa-chevron-right" id="icon-chevron-right"></i>
    </a>
    
    
        <a href="/linux/debian-backporting/" id="article-nav-older" class="article-nav-link-wrap">
        <strong class="article-nav-caption">older</strong>
        <p class="article-nav-title">Backporting packages in Debian</p>
        <i class="icon fa fa-chevron-left" id="icon-chevron-left"></i>
        </a>
    
</nav>

    
    <div class="widgets-container">
        
            
                
    <div class="widget-wrap">
        <h3 class="widget-title">recents</h3>
        <div class="widget">
            <ul id="recent-post" class="no-thumbnail">
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/drums/">drums</a></p>
                            <p class="item-title"><a href="/drums/rudimental-permutations/" class="title">On permutations of rudiments</a></p>
                            <p class="item-date"><time datetime="2015-12-14T06:00:00.000Z" itemprop="datePublished">2015-12-14</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/linux/">linux</a></p>
                            <p class="item-title"><a href="/linux/vimrc-guide/" class="title">Vim beginner&#39;s customization guide</a></p>
                            <p class="item-date"><time datetime="2015-08-02T05:00:00.000Z" itemprop="datePublished">2015-08-02</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/linux/">linux</a></p>
                            <p class="item-title"><a href="/linux/fzmp/" class="title">Fuzzy searching for MPD in Bash</a></p>
                            <p class="item-date"><time datetime="2014-11-02T05:00:00.000Z" itemprop="datePublished">2014-11-02</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/linux/">linux</a></p>
                            <p class="item-title"><a href="/linux/debian-backporting/" class="title">Backporting packages in Debian</a></p>
                            <p class="item-date"><time datetime="2013-10-22T05:00:00.000Z" itemprop="datePublished">2013-10-22</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

            
                
    <div class="widget-wrap widget-float">
        <h3 class="widget-title">tag cloud</h3>
        <div class="widget tagcloud">
            <a href="/tags/bash/" style="font-size: 10px;">bash</a> <a href="/tags/debian/" style="font-size: 10px;">debian</a> <a href="/tags/fzf/" style="font-size: 10px;">fzf</a> <a href="/tags/mpd/" style="font-size: 10px;">mpd</a> <a href="/tags/permutations/" style="font-size: 10px;">permutations</a> <a href="/tags/rudiments/" style="font-size: 10px;">rudiments</a> <a href="/tags/vim/" style="font-size: 10px;">vim</a>
        </div>
    </div>


            
        
    </div>
</aside>
                </div>
            </div>
        </div>
        <footer id="footer">
    <div class="container">
        <div class="container-inner">
            <a id="back-to-top" href="javascript:;"><i class="icon fa fa-angle-up"></i></a>
            <div class="credit">
                <h1 class="logo-wrap">
                    <a href="/" class="logo"></a>
                </h1>
                <p>&copy; 2016 DanielFGray</p>
                <!-- <p>Powered by <a href="//hexo.io/" target="_blank">Hexo</a>. Theme by <a href="//github.com/ppoffice" target="_blank">PPOffice</a></p> -->
            </div>
        </div>
    </div>
</footer>

        
    
    <script>
    var disqus_shortname = 'danielfgraygithubio';
    
    
    var disqus_url = 'http://danielfgray.github.io/linux/fzmp/';
    
    (function() {
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>



    
        <script src="/vendor/fancybox/jquery.fancybox.pack.js"></script>
    

    
        <script src="/vendor/scrollLoading/jquery.scrollLoading.js"></script>
        <script src="/vendor/scrollLoading/main.js"></script>
    


<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>
